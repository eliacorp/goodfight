(function (global, factory) {
    typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('@angular/core'), require('@angular/common/http'), require('@angular/platform-browser'), require('rxjs'), require('rxjs/operators'), require('@angular/common')) :
    typeof define === 'function' && define.amd ? define('@gorniv/ngx-transfer-http', ['exports', '@angular/core', '@angular/common/http', '@angular/platform-browser', 'rxjs', 'rxjs/operators', '@angular/common'], factory) :
    (factory((global.gorniv = global.gorniv || {}, global.gorniv['ngx-transfer-http'] = {}),global.ng.core,global.ng.common.http,global.ng.platformBrowser,global.rxjs,global.rxjs.operators,global.ng.common));
}(this, (function (exports,core,http,platformBrowser,rxjs,operators,common) { 'use strict';

    /**
     * @fileoverview added by tsickle
     * @suppress {checkTypes} checked by tsc
     */
    var TransferHttpService = (function () {
        function TransferHttpService(transferState, httpClient, platformId) {
            this.transferState = transferState;
            this.httpClient = httpClient;
            this.platformId = platformId;
        }
        /**
         * @param {?} method
         * @param {?} uri
         * @param {?=} options
         * @return {?}
         */
        TransferHttpService.prototype.request = /**
         * @param {?} method
         * @param {?} uri
         * @param {?=} options
         * @return {?}
         */
            function (method, uri, options) {
                var _this = this;
                // tslint:disable-next-line:no-shadowed-variable
                return this.getData(method, uri, options, function (method, url, options) {
                    return _this.httpClient.request(method, url, options);
                });
            };
        /**
         * Performs a request with `get` http method.
         */
        /**
         * Performs a request with `get` http method.
         * @param {?} url
         * @param {?=} options
         * @return {?}
         */
        TransferHttpService.prototype.get = /**
         * Performs a request with `get` http method.
         * @param {?} url
         * @param {?=} options
         * @return {?}
         */
            function (url, options) {
                var _this = this;
                // tslint:disable-next-line:no-shadowed-variable
                return this.getData('get', url, options, function (method, url, options) {
                    return _this.httpClient.get(url, options);
                });
            };
        /**
         * Performs a request with `post` http method.
         */
        /**
         * Performs a request with `post` http method.
         * @param {?} url
         * @param {?} body
         * @param {?=} options
         * @return {?}
         */
        TransferHttpService.prototype.post = /**
         * Performs a request with `post` http method.
         * @param {?} url
         * @param {?} body
         * @param {?=} options
         * @return {?}
         */
            function (url, body, options) {
                var _this = this;
                // tslint:disable-next-line:no-shadowed-variable
                return this.getPostData('post', url, body, options, function (url, body, options) {
                    return _this.httpClient.post(url, body, options);
                });
            };
        /**
         * Performs a request with `put` http method.
         */
        /**
         * Performs a request with `put` http method.
         * @param {?} url
         * @param {?} body
         * @param {?=} options
         * @return {?}
         */
        TransferHttpService.prototype.put = /**
         * Performs a request with `put` http method.
         * @param {?} url
         * @param {?} body
         * @param {?=} options
         * @return {?}
         */
            function (url, body, options) {
                var _this = this;
                // tslint:disable-next-line:no-shadowed-variable
                return this.getData('put', url, options, function (method, url, options) {
                    return _this.httpClient.put(url, options);
                });
            };
        /**
         * Performs a request with `delete` http method.
         */
        /**
         * Performs a request with `delete` http method.
         * @param {?} url
         * @param {?=} options
         * @return {?}
         */
        TransferHttpService.prototype.delete = /**
         * Performs a request with `delete` http method.
         * @param {?} url
         * @param {?=} options
         * @return {?}
         */
            function (url, options) {
                var _this = this;
                // tslint:disable-next-line:no-shadowed-variable
                return this.getData('delete', url, options, function (method, url, options) {
                    return _this.httpClient.delete(url, options);
                });
            };
        /**
         * Performs a request with `patch` http method.
         */
        /**
         * Performs a request with `patch` http method.
         * @param {?} url
         * @param {?} body
         * @param {?=} options
         * @return {?}
         */
        TransferHttpService.prototype.patch = /**
         * Performs a request with `patch` http method.
         * @param {?} url
         * @param {?} body
         * @param {?=} options
         * @return {?}
         */
            function (url, body, options) {
                var _this = this;
                // tslint:disable-next-line:no-shadowed-variable
                return this.getPostData('patch', url, body, options, function (url, body, options) {
                    return _this.httpClient.patch(url, body, options);
                });
            };
        /**
         * Performs a request with `head` http method.
         */
        /**
         * Performs a request with `head` http method.
         * @param {?} url
         * @param {?=} options
         * @return {?}
         */
        TransferHttpService.prototype.head = /**
         * Performs a request with `head` http method.
         * @param {?} url
         * @param {?=} options
         * @return {?}
         */
            function (url, options) {
                var _this = this;
                // tslint:disable-next-line:no-shadowed-variable
                return this.getData('head', url, options, function (method, url, options) {
                    return _this.httpClient.head(url, options);
                });
            };
        /**
         * Performs a request with `options` http method.
         */
        /**
         * Performs a request with `options` http method.
         * @param {?} url
         * @param {?=} options
         * @return {?}
         */
        TransferHttpService.prototype.options = /**
         * Performs a request with `options` http method.
         * @param {?} url
         * @param {?=} options
         * @return {?}
         */
            function (url, options) {
                var _this = this;
                // tslint:disable-next-line:no-shadowed-variable
                return this.getData('options', url, options, function (method, url, options) {
                    return _this.httpClient.options(url, options);
                });
            };
        /**
         * @param {?} method
         * @param {?} uri
         * @param {?} options
         * @param {?} callback
         * @return {?}
         */
        TransferHttpService.prototype.getData = /**
         * @param {?} method
         * @param {?} uri
         * @param {?} options
         * @param {?} callback
         * @return {?}
         */
            function (method, uri, options, callback) {
                var _this = this;
                var /** @type {?} */ url = uri;
                if (typeof uri !== 'string') {
                    url = uri.url;
                }
                var /** @type {?} */ key = url + (options ? JSON.stringify(options) : '');
                try {
                    return this.resolveData(key);
                }
                catch (e) {
                    return callback(method, uri, options)
                        .pipe(operators.tap(function (data) {
                        if (common.isPlatformBrowser(_this.platformId)) ;
                        if (common.isPlatformServer(_this.platformId)) {
                            _this.setCache(key, data);
                        }
                    }));
                }
            };
        /**
         * @param {?} method
         * @param {?} uri
         * @param {?} body
         * @param {?} options
         * @param {?} callback
         * @return {?}
         */
        TransferHttpService.prototype.getPostData = /**
         * @param {?} method
         * @param {?} uri
         * @param {?} body
         * @param {?} options
         * @param {?} callback
         * @return {?}
         */
            function (method, uri, body, options, callback) {
                var _this = this;
                var /** @type {?} */ url = uri;
                if (typeof uri !== 'string') {
                    url = uri.url;
                }
                var /** @type {?} */ key = url + (body ? JSON.stringify(body) : '') + (options ? JSON.stringify(options) : '');
                try {
                    return this.resolveData(key);
                }
                catch (e) {
                    return callback(uri, body, options)
                        .pipe(operators.tap(function (data) {
                        if (common.isPlatformBrowser(_this.platformId)) ;
                        if (common.isPlatformServer(_this.platformId)) {
                            _this.setCache(key, data);
                        }
                    }));
                }
            };
        /**
         * @param {?} key
         * @return {?}
         */
        TransferHttpService.prototype.resolveData = /**
         * @param {?} key
         * @return {?}
         */
            function (key) {
                var /** @type {?} */ data = this.getFromCache(key);
                if (!data) {
                    throw new Error();
                }
                if (common.isPlatformBrowser(this.platformId)) {
                    // Client only code.
                    this.transferState.remove(key);
                }
                if (common.isPlatformServer(this.platformId)) ;
                return rxjs.from(Promise.resolve(data));
            };
        /**
         * @param {?} key
         * @param {?} data
         * @return {?}
         */
        TransferHttpService.prototype.setCache = /**
         * @param {?} key
         * @param {?} data
         * @return {?}
         */
            function (key, data) {
                return this.transferState.set(key, data);
            };
        /**
         * @param {?} key
         * @return {?}
         */
        TransferHttpService.prototype.getFromCache = /**
         * @param {?} key
         * @return {?}
         */
            function (key) {
                return this.transferState.get(key, null);
            };
        TransferHttpService.decorators = [
            { type: core.Injectable },
        ];
        /** @nocollapse */
        TransferHttpService.ctorParameters = function () {
            return [
                { type: platformBrowser.TransferState, },
                { type: http.HttpClient, },
                { type: Object, decorators: [{ type: core.Inject, args: [core.PLATFORM_ID,] },] },
            ];
        };
        return TransferHttpService;
    }());

    /**
     * @fileoverview added by tsickle
     * @suppress {checkTypes} checked by tsc
     */
    var TransferHttpModule = (function () {
        function TransferHttpModule() {
        }
        TransferHttpModule.decorators = [
            { type: core.NgModule, args: [{
                        providers: [TransferHttpService]
                    },] },
        ];
        return TransferHttpModule;
    }());

    /**
     * @fileoverview added by tsickle
     * @suppress {checkTypes} checked by tsc
     */

    /**
     * @fileoverview added by tsickle
     * @suppress {checkTypes} checked by tsc
     */

    /**
     * @fileoverview added by tsickle
     * @suppress {checkTypes} checked by tsc
     */

    exports.TransferHttpModule = TransferHttpModule;
    exports.TransferHttpService = TransferHttpService;

    Object.defineProperty(exports, '__esModule', { value: true });

})));

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29ybml2LW5neC10cmFuc2Zlci1odHRwLnVtZC5qcy5tYXAiLCJzb3VyY2VzIjpbIm5nOi8vQGdvcm5pdi9uZ3gtdHJhbnNmZXItaHR0cC9zcmMvdHJhbnNmZXItaHR0cC5zZXJ2aWNlLnRzIiwibmc6Ly9AZ29ybml2L25neC10cmFuc2Zlci1odHRwL3NyYy90cmFuc2Zlci1odHRwLm1vZHVsZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3QsIFBMQVRGT1JNX0lEIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwSGVhZGVycywgSHR0cFBhcmFtcyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IFRyYW5zZmVyU3RhdGUgfSBmcm9tICdAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyJztcbmltcG9ydCB7IE9ic2VydmFibGUsIGZyb20gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IGlzUGxhdGZvcm1Ccm93c2VyLCBpc1BsYXRmb3JtU2VydmVyIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFRyYW5zZmVySHR0cFNlcnZpY2Uge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcm90ZWN0ZWQgdHJhbnNmZXJTdGF0ZTogVHJhbnNmZXJTdGF0ZSxcbiAgICBwcml2YXRlIGh0dHBDbGllbnQ6IEh0dHBDbGllbnQsXG4gICAgQEluamVjdChQTEFURk9STV9JRCkgcHJpdmF0ZSBwbGF0Zm9ybUlkOiBPYmplY3RcbiAgKSB7XG5cbiAgfVxuXG4gIHB1YmxpYyByZXF1ZXN0KG1ldGhvZDogc3RyaW5nLCB1cmk6IHN0cmluZyB8IFJlcXVlc3QsIG9wdGlvbnM/OiB7XG4gICAgYm9keT86IGFueTtcbiAgICBoZWFkZXJzPzogSHR0cEhlYWRlcnMgfCB7XG4gICAgICBbaGVhZGVyOiBzdHJpbmddOiBzdHJpbmcgfCBzdHJpbmdbXTtcbiAgICB9O1xuICAgIHJlcG9ydFByb2dyZXNzPzogYm9vbGVhbjtcbiAgICBvYnNlcnZlPzogJ3Jlc3BvbnNlJztcbiAgICBwYXJhbXM/OiBIdHRwUGFyYW1zIHwge1xuICAgICAgW3BhcmFtOiBzdHJpbmddOiBzdHJpbmcgfCBzdHJpbmdbXTtcbiAgICB9O1xuICAgIHJlc3BvbnNlVHlwZT86ICdqc29uJztcbiAgICB3aXRoQ3JlZGVudGlhbHM/OiBib29sZWFuO1xuICB9KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tc2hhZG93ZWQtdmFyaWFibGVcbiAgICByZXR1cm4gdGhpcy5nZXREYXRhKG1ldGhvZCwgdXJpLCBvcHRpb25zLCAobWV0aG9kOiBzdHJpbmcsIHVybDogc3RyaW5nLCBvcHRpb25zOiBhbnkpID0+IHtcbiAgICAgIHJldHVybiB0aGlzLmh0dHBDbGllbnQucmVxdWVzdChtZXRob2QsIHVybCwgb3B0aW9ucyk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogUGVyZm9ybXMgYSByZXF1ZXN0IHdpdGggYGdldGAgaHR0cCBtZXRob2QuXG4gICAqL1xuICBnZXQodXJsOiBzdHJpbmcsIG9wdGlvbnM/OiB7XG4gICAgaGVhZGVycz86IEh0dHBIZWFkZXJzIHwge1xuICAgICAgW2hlYWRlcjogc3RyaW5nXTogc3RyaW5nIHwgc3RyaW5nW107XG4gICAgfTtcbiAgICBvYnNlcnZlPzogJ3Jlc3BvbnNlJztcbiAgICBwYXJhbXM/OiBIdHRwUGFyYW1zIHwge1xuICAgICAgW3BhcmFtOiBzdHJpbmddOiBzdHJpbmcgfCBzdHJpbmdbXTtcbiAgICB9O1xuICAgIHJlcG9ydFByb2dyZXNzPzogYm9vbGVhbjtcbiAgICByZXNwb25zZVR5cGU/OiAnanNvbic7XG4gICAgd2l0aENyZWRlbnRpYWxzPzogYm9vbGVhbjtcbiAgfSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXNoYWRvd2VkLXZhcmlhYmxlXG4gICAgcmV0dXJuIHRoaXMuZ2V0RGF0YSgnZ2V0JywgdXJsLCBvcHRpb25zLCAobWV0aG9kOiBzdHJpbmcsIHVybDogc3RyaW5nLCBvcHRpb25zOiBhbnkpID0+IHtcbiAgICAgIHJldHVybiB0aGlzLmh0dHBDbGllbnQuZ2V0KHVybCwgb3B0aW9ucyk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogUGVyZm9ybXMgYSByZXF1ZXN0IHdpdGggYHBvc3RgIGh0dHAgbWV0aG9kLlxuICAgKi9cbiAgcG9zdCh1cmw6IHN0cmluZywgYm9keTogYW55LCBvcHRpb25zPzoge1xuICAgIGhlYWRlcnM/OiBIdHRwSGVhZGVycyB8IHtcbiAgICAgIFtoZWFkZXI6IHN0cmluZ106IHN0cmluZyB8IHN0cmluZ1tdO1xuICAgIH07XG4gICAgb2JzZXJ2ZT86ICdyZXNwb25zZSc7XG4gICAgcGFyYW1zPzogSHR0cFBhcmFtcyB8IHtcbiAgICAgIFtwYXJhbTogc3RyaW5nXTogc3RyaW5nIHwgc3RyaW5nW107XG4gICAgfTtcbiAgICByZXBvcnRQcm9ncmVzcz86IGJvb2xlYW47XG4gICAgcmVzcG9uc2VUeXBlPzogJ2pzb24nO1xuICAgIHdpdGhDcmVkZW50aWFscz86IGJvb2xlYW47XG4gIH0pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1zaGFkb3dlZC12YXJpYWJsZVxuICAgIHJldHVybiB0aGlzLmdldFBvc3REYXRhKCdwb3N0JywgdXJsLCBib2R5LCBvcHRpb25zLCAodXJsOiBzdHJpbmcsIGJvZHk6IGFueSwgb3B0aW9uczogYW55KTogT2JzZXJ2YWJsZTxhbnk+ID0+IHtcbiAgICAgIHJldHVybiB0aGlzLmh0dHBDbGllbnQucG9zdCh1cmwsIGJvZHksIG9wdGlvbnMpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm1zIGEgcmVxdWVzdCB3aXRoIGBwdXRgIGh0dHAgbWV0aG9kLlxuICAgKi9cbiAgcHV0KHVybDogc3RyaW5nLCBib2R5OiBhbnksIG9wdGlvbnM/OiB7XG4gICAgaGVhZGVycz86IEh0dHBIZWFkZXJzIHwge1xuICAgICAgW2hlYWRlcjogc3RyaW5nXTogc3RyaW5nIHwgc3RyaW5nW107XG4gICAgfTtcbiAgICBvYnNlcnZlPzogJ2JvZHknO1xuICAgIHBhcmFtcz86IEh0dHBQYXJhbXMgfCB7XG4gICAgICBbcGFyYW06IHN0cmluZ106IHN0cmluZyB8IHN0cmluZ1tdO1xuICAgIH07XG4gICAgcmVwb3J0UHJvZ3Jlc3M/OiBib29sZWFuO1xuICAgIHJlc3BvbnNlVHlwZT86ICdqc29uJztcbiAgICB3aXRoQ3JlZGVudGlhbHM/OiBib29sZWFuO1xuICB9KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tc2hhZG93ZWQtdmFyaWFibGVcbiAgICByZXR1cm4gdGhpcy5nZXREYXRhKCdwdXQnLCB1cmwsIG9wdGlvbnMsIChtZXRob2Q6IHN0cmluZywgdXJsOiBzdHJpbmcsIG9wdGlvbnM6IGFueSkgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMuaHR0cENsaWVudC5wdXQodXJsLCBvcHRpb25zKTtcbiAgICB9KTtcbiAgfVxuXG5cbiAgLyoqXG4gICAqIFBlcmZvcm1zIGEgcmVxdWVzdCB3aXRoIGBkZWxldGVgIGh0dHAgbWV0aG9kLlxuICAgKi9cbiAgZGVsZXRlKHVybDogc3RyaW5nLCBvcHRpb25zPzoge1xuICAgIGhlYWRlcnM/OiBIdHRwSGVhZGVycyB8IHtcbiAgICAgIFtoZWFkZXI6IHN0cmluZ106IHN0cmluZyB8IHN0cmluZ1tdO1xuICAgIH07XG4gICAgb2JzZXJ2ZT86ICdyZXNwb25zZSc7XG4gICAgcGFyYW1zPzogSHR0cFBhcmFtcyB8IHtcbiAgICAgIFtwYXJhbTogc3RyaW5nXTogc3RyaW5nIHwgc3RyaW5nW107XG4gICAgfTtcbiAgICByZXBvcnRQcm9ncmVzcz86IGJvb2xlYW47XG4gICAgcmVzcG9uc2VUeXBlPzogJ2pzb24nO1xuICAgIHdpdGhDcmVkZW50aWFscz86IGJvb2xlYW47XG4gIH0pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1zaGFkb3dlZC12YXJpYWJsZVxuICAgIHJldHVybiB0aGlzLmdldERhdGEoJ2RlbGV0ZScsIHVybCwgb3B0aW9ucywgKG1ldGhvZDogc3RyaW5nLCB1cmw6IHN0cmluZywgb3B0aW9uczogYW55KSA9PiB7XG4gICAgICByZXR1cm4gdGhpcy5odHRwQ2xpZW50LmRlbGV0ZSh1cmwsIG9wdGlvbnMpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm1zIGEgcmVxdWVzdCB3aXRoIGBwYXRjaGAgaHR0cCBtZXRob2QuXG4gICAqL1xuICBwYXRjaCh1cmw6IHN0cmluZywgYm9keTogYW55LCBvcHRpb25zPzoge1xuICAgIGhlYWRlcnM/OiBIdHRwSGVhZGVycyB8IHtcbiAgICAgIFtoZWFkZXI6IHN0cmluZ106IHN0cmluZyB8IHN0cmluZ1tdO1xuICAgIH07XG4gICAgb2JzZXJ2ZT86ICdyZXNwb25zZSc7XG4gICAgcGFyYW1zPzogSHR0cFBhcmFtcyB8IHtcbiAgICAgIFtwYXJhbTogc3RyaW5nXTogc3RyaW5nIHwgc3RyaW5nW107XG4gICAgfTtcbiAgICByZXBvcnRQcm9ncmVzcz86IGJvb2xlYW47XG4gICAgcmVzcG9uc2VUeXBlPzogJ2pzb24nO1xuICAgIHdpdGhDcmVkZW50aWFscz86IGJvb2xlYW47XG4gIH0pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1zaGFkb3dlZC12YXJpYWJsZVxuICAgIHJldHVybiB0aGlzLmdldFBvc3REYXRhKCdwYXRjaCcsIHVybCwgYm9keSwgb3B0aW9ucywgKHVybDogc3RyaW5nLCBib2R5OiBhbnksIG9wdGlvbnM6IGFueSk6IE9ic2VydmFibGU8YW55PiA9PiB7XG4gICAgICByZXR1cm4gdGhpcy5odHRwQ2xpZW50LnBhdGNoKHVybCwgYm9keSwgb3B0aW9ucyk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogUGVyZm9ybXMgYSByZXF1ZXN0IHdpdGggYGhlYWRgIGh0dHAgbWV0aG9kLlxuICAgKi9cbiAgaGVhZCh1cmw6IHN0cmluZywgb3B0aW9ucz86IHtcbiAgICBoZWFkZXJzPzogSHR0cEhlYWRlcnMgfCB7XG4gICAgICBbaGVhZGVyOiBzdHJpbmddOiBzdHJpbmcgfCBzdHJpbmdbXTtcbiAgICB9O1xuICAgIG9ic2VydmU/OiAncmVzcG9uc2UnO1xuICAgIHBhcmFtcz86IEh0dHBQYXJhbXMgfCB7XG4gICAgICBbcGFyYW06IHN0cmluZ106IHN0cmluZyB8IHN0cmluZ1tdO1xuICAgIH07XG4gICAgcmVwb3J0UHJvZ3Jlc3M/OiBib29sZWFuO1xuICAgIHJlc3BvbnNlVHlwZT86ICdqc29uJztcbiAgICB3aXRoQ3JlZGVudGlhbHM/OiBib29sZWFuO1xuICB9KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tc2hhZG93ZWQtdmFyaWFibGVcbiAgICByZXR1cm4gdGhpcy5nZXREYXRhKCdoZWFkJywgdXJsLCBvcHRpb25zLCAobWV0aG9kOiBzdHJpbmcsIHVybDogc3RyaW5nLCBvcHRpb25zOiBhbnkpID0+IHtcbiAgICAgIHJldHVybiB0aGlzLmh0dHBDbGllbnQuaGVhZCh1cmwsIG9wdGlvbnMpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm1zIGEgcmVxdWVzdCB3aXRoIGBvcHRpb25zYCBodHRwIG1ldGhvZC5cbiAgICovXG4gIG9wdGlvbnModXJsOiBzdHJpbmcsIG9wdGlvbnM/OiB7XG4gICAgaGVhZGVycz86IEh0dHBIZWFkZXJzIHwge1xuICAgICAgW2hlYWRlcjogc3RyaW5nXTogc3RyaW5nIHwgc3RyaW5nW107XG4gICAgfTtcbiAgICBvYnNlcnZlPzogJ3Jlc3BvbnNlJztcbiAgICBwYXJhbXM/OiBIdHRwUGFyYW1zIHwge1xuICAgICAgW3BhcmFtOiBzdHJpbmddOiBzdHJpbmcgfCBzdHJpbmdbXTtcbiAgICB9O1xuICAgIHJlcG9ydFByb2dyZXNzPzogYm9vbGVhbjtcbiAgICByZXNwb25zZVR5cGU/OiAnanNvbic7XG4gICAgd2l0aENyZWRlbnRpYWxzPzogYm9vbGVhbjtcbiAgfSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXNoYWRvd2VkLXZhcmlhYmxlXG4gICAgcmV0dXJuIHRoaXMuZ2V0RGF0YSgnb3B0aW9ucycsIHVybCwgb3B0aW9ucywgKG1ldGhvZDogc3RyaW5nLCB1cmw6IHN0cmluZywgb3B0aW9uczogYW55KSA9PiB7XG4gICAgICByZXR1cm4gdGhpcy5odHRwQ2xpZW50Lm9wdGlvbnModXJsLCBvcHRpb25zKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgcHJpdmF0ZSBnZXREYXRhKG1ldGhvZDogc3RyaW5nLFxuICAgIHVyaTogc3RyaW5nIHwgUmVxdWVzdCxcbiAgICBvcHRpb25zOiBhbnksXG4gICAgY2FsbGJhY2s6IChtZXRob2Q6IHN0cmluZywgdXJpOiBzdHJpbmcgfCBSZXF1ZXN0LCBvcHRpb25zOiBhbnkpID0+IE9ic2VydmFibGU8YW55Pik6IGFueSB7XG5cbiAgICBsZXQgdXJsID0gdXJpO1xuXG4gICAgaWYgKHR5cGVvZiB1cmkgIT09ICdzdHJpbmcnKSB7XG4gICAgICB1cmwgPSB1cmkudXJsO1xuICAgIH1cblxuICAgIGNvbnN0IGtleSA9IHVybCArIChvcHRpb25zID8gSlNPTi5zdHJpbmdpZnkob3B0aW9ucykgOiAnJyk7XG5cbiAgICB0cnkge1xuICAgICAgcmV0dXJuIHRoaXMucmVzb2x2ZURhdGEoa2V5KTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICByZXR1cm4gY2FsbGJhY2sobWV0aG9kLCB1cmksIG9wdGlvbnMpXG4gICAgICAgIC5waXBlKHRhcChkYXRhID0+IHtcbiAgICAgICAgICBpZiAoaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybUlkKSkge1xuICAgICAgICAgICAgLy8gQ2xpZW50IG9ubHkgY29kZS5cbiAgICAgICAgICAgIC8vIG5vdGhpbmc7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChpc1BsYXRmb3JtU2VydmVyKHRoaXMucGxhdGZvcm1JZCkpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0Q2FjaGUoa2V5LCBkYXRhKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pKTtcbiAgICB9XG4gIH1cblxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gIHByaXZhdGUgZ2V0UG9zdERhdGEobWV0aG9kOiBzdHJpbmcsXG4gICAgdXJpOiBzdHJpbmcgfCBSZXF1ZXN0LFxuICAgIGJvZHk6IGFueSwgb3B0aW9uczogYW55LFxuICAgIGNhbGxiYWNrOiAodXJpOiBzdHJpbmcgfCBSZXF1ZXN0LCBib2R5OiBhbnksIG9wdGlvbnM6IGFueSkgPT4gT2JzZXJ2YWJsZTxSZXNwb25zZT4pOiBhbnkge1xuXG4gICAgbGV0IHVybCA9IHVyaTtcblxuICAgIGlmICh0eXBlb2YgdXJpICE9PSAnc3RyaW5nJykge1xuICAgICAgdXJsID0gdXJpLnVybDtcbiAgICB9XG5cbiAgICBjb25zdCBrZXkgPSB1cmwgKyAoYm9keSA/IEpTT04uc3RyaW5naWZ5KGJvZHkpIDogJycpICsgKG9wdGlvbnMgPyBKU09OLnN0cmluZ2lmeShvcHRpb25zKSA6ICcnKTtcblxuICAgIHRyeSB7XG4gICAgICByZXR1cm4gdGhpcy5yZXNvbHZlRGF0YShrZXkpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJldHVybiBjYWxsYmFjayh1cmksIGJvZHksIG9wdGlvbnMpXG4gICAgICAgIC5waXBlKHRhcChkYXRhID0+IHtcbiAgICAgICAgICBpZiAoaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybUlkKSkge1xuICAgICAgICAgICAgLy8gQ2xpZW50IG9ubHkgY29kZS5cbiAgICAgICAgICAgIC8vIG5vdGhpbmc7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChpc1BsYXRmb3JtU2VydmVyKHRoaXMucGxhdGZvcm1JZCkpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0Q2FjaGUoa2V5LCBkYXRhKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlc29sdmVEYXRhKGtleTogYW55KTogYW55IHtcbiAgICBjb25zdCBkYXRhID0gdGhpcy5nZXRGcm9tQ2FjaGUoa2V5KTtcblxuICAgIGlmICghZGF0YSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCk7XG4gICAgfVxuXG4gICAgaWYgKGlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm1JZCkpIHtcbiAgICAgIC8vIENsaWVudCBvbmx5IGNvZGUuXG4gICAgICB0aGlzLnRyYW5zZmVyU3RhdGUucmVtb3ZlKGtleSk7XG4gICAgfVxuICAgIGlmIChpc1BsYXRmb3JtU2VydmVyKHRoaXMucGxhdGZvcm1JZCkpIHtcbiAgICAgIC8vIFNlcnZlciBvbmx5IGNvZGUuXG4gICAgfVxuXG4gICAgcmV0dXJuIGZyb20oUHJvbWlzZS5yZXNvbHZlKGRhdGEpKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0Q2FjaGUoa2V5LCBkYXRhKTogYW55IHtcbiAgICByZXR1cm4gdGhpcy50cmFuc2ZlclN0YXRlLnNldChrZXksIGRhdGEpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRGcm9tQ2FjaGUoa2V5KTogYW55IHtcbiAgICByZXR1cm4gdGhpcy50cmFuc2ZlclN0YXRlLmdldChrZXksIG51bGwpO1xuICB9XG59XG4iLCJpbXBvcnQgeyBOZ01vZHVsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBUcmFuc2Zlckh0dHBTZXJ2aWNlIH0gZnJvbSAnLi90cmFuc2Zlci1odHRwLnNlcnZpY2UnO1xuXG5ATmdNb2R1bGUoe1xuICBwcm92aWRlcnM6IFtUcmFuc2Zlckh0dHBTZXJ2aWNlXVxufSlcbmV4cG9ydCBjbGFzcyBUcmFuc2Zlckh0dHBNb2R1bGUge1xufVxuIl0sIm5hbWVzIjpbInRhcCIsImlzUGxhdGZvcm1Ccm93c2VyIiwiaXNQbGF0Zm9ybVNlcnZlciIsImZyb20iLCJJbmplY3RhYmxlIiwiVHJhbnNmZXJTdGF0ZSIsIkh0dHBDbGllbnQiLCJJbmplY3QiLCJQTEFURk9STV9JRCIsIk5nTW9kdWxlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUE7UUFTRSw2QkFDWSxhQUE0QixFQUM5QixZQUNxQjtZQUZuQixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtZQUM5QixlQUFVLEdBQVYsVUFBVTtZQUNXLGVBQVUsR0FBVixVQUFVO1NBR3hDOzs7Ozs7O1FBRU0scUNBQU87Ozs7OztzQkFBQyxNQUFjLEVBQUUsR0FBcUIsRUFBRSxPQVlyRDs7O2dCQUVDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRSxVQUFDLE1BQWMsRUFBRSxHQUFXLEVBQUUsT0FBWTtvQkFDbEYsT0FBTyxLQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO2lCQUN0RCxDQUFDLENBQUM7Ozs7Ozs7Ozs7O1FBTUwsaUNBQUc7Ozs7OztZQUFILFVBQUksR0FBVyxFQUFFLE9BV2hCO2dCQVhELGlCQWdCQzs7Z0JBSEMsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsT0FBTyxFQUFFLFVBQUMsTUFBYyxFQUFFLEdBQVcsRUFBRSxPQUFZO29CQUNqRixPQUFPLEtBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQztpQkFDMUMsQ0FBQyxDQUFDO2FBQ0o7Ozs7Ozs7Ozs7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